<!DOCTYPE HTML>
<html>
<head><meta content="text/html; charset=UTF-8">
    <title>Camera WiFi Remote Control</title>
    <script src="/WIFICTRL/140medley.min.js"></script>
<style>
body {
  background: #B8D7FF;
}

.fs7{
  max-width:400px;
  margin:50px auto;
  background:#fff;
  border-radius:2px;
  padding:20px;
  font-family: Georgia, "Times New Roman", Times, serif;
}
.fs7 h1{
  display: block;
  text-align: center;
  padding: 0;
  margin: 0px 0px 20px 0px;
  color: #5C5C5C;
  font-size:x-large;
}

.center {
  text-align: center;
}
.left {
  text-align: left;
}
.right {
  text-align: right;
}
.img_sm img {
  width: 80%; 
  height: auto;
}
</style>

<script>
var lang = navigator.language || navigator.userLanguage;
var r = new j();
var status ={};
var rt = 500; // (initial) refresh time for status in milliseconds
var bindings;  // a list of values and binding-expression for updating the page from dynamic values
var tmr_cntDn; // Timer reference for Countdown Interval
var cntr_cntDn = null; // Countdown Counter
var tmr_id = null;  // Timer ID for first shot delay

/* For debugging: */
if (window.location.hostname == "heilig-family.selfhost.eu")
  cgipath="cgi-bin/status.cgi"
else
  cgipath="/WIFICTRL/status.lua";

//var list_of_bound_stuff = {"key": { "value:"the value", "binding" : [dom_el1, dom_el2, ...] } };


function getStatusXhr(flag) {
	geturi = cgipath + "?cmd=get";
  r.open("GET", geturi, true);
  r.onreadystatechange = function () {
	  if (r.readyState == 4)
	  {
	    populateStatus(r.responseText, flag);
	  }
  };
  r.send()
}

function populateStatus(jsondata, do_cyclic) {
  var para=t('<div id="#{s[this].name}">' +
             '#{s[this].name}: '+
             '<span class="val">#{s[this].value}</span>'+
             '</div>')
  try {
    s = JSON.parse(jsondata);
  } catch (e) {
    s="";
  }
  // loop through all objects of the received JSON data
  for (var e in s) {
    el=$('#'+s[e].name);  // check if an element is already present in the DOM
    if (!el) {
      // element is not present yet, add it to DOM
      $('#last').insertAdjacentHTML( 'beforebegin', para(e));
      // add element to bindings list if it does not exist yet
      if (! bindings[s[e].name]) {
        bindings[s[e].name]={};
        bindings[s[e].name].oldvalue=-1;
        bindings[s[e].name].binding=[];
      }
      // The binding must be added, even if the element already existed otherwise
      bindings[s[e].name].binding.push('$(".val", $("#' + s[e].name + '"))[0].innerHTML');
    }
    // add new value from JSON data to bindings list
    if (bindings[s[e].name]) {
      bindings[s[e].name].value = s[e].value;
    }
  }
  // check if any value changed, if not, increase update interval
  var inc=true;
  for (var i in bindings) {
    if (bindings[i].oldvalue != bindings[i].value) {
      rt = 500;
      inc = false;
      break;
    }
  }
  if (inc) {
    // status has not been updated ==> increase update interval
    if (rt < 5000) rt += 500
  }

  if (do_cyclic) {
    setTimeout(function() {getStatusXhr(true);}, rt);
  }

  // call function to update the DOM with new values
  updBoundItems();
}


function action(cmd) {
  rt = 500;
	geturi = cgipath + "?cmd=set&par="+cmd;
  r.open("GET", geturi, true);
  r.onreadystatechange = function () {
	  if (r.readyState == 4)
	  {
	    populateStatus(r.responseText, false);
	  }
  };
  r.send()
}

function shoot(cmd) {
  cntr_cntDn = $("#delay").value * 1000;
  if (tmr_cntDn) {
    clearInterval(cntr_cntDn);
    cntr_cntDn = null;
  }
  if (tmr_id) {
    clearTimeout(tmr_id);
    tmr_id = null;
  }
  if (cntr_cntDn > 0)
  {
    tmr_cntDn = setInterval(countDown, 1000);
  }
  tmr_id = setTimeout(function() { action(cmd); }, cntr_cntDn);
}

function countDown() {
  cntr_cntDn -= 1000;
  alert("Countdown: " + cntr_cntDn);
  if (cntr_cntDn <= 0) {
    cntr_cntDn = 0;
    clearInterval(tmr_cntDn);
    tmr_cntDn = null;
  }
}

function updBoundItems() {
  Object.keys(bindings).forEach(function(key,index) {
    // key: the name of the object key
    // index: the ordinal position of the key within the object
    var p = bindings[key];
    // alert("Key: " + key + "    Wert: " + bindings[key].value + "  Anzahl bindings:" + bindings[key].binding.length);
    if (p.value != p.oldvalue) {
      p.oldvalue = p.value;
      for (var i in bindings[key].binding) {
        eval(p.binding[i] + " = \"" + p.value + "\"");
      }
    }
  });
}

window.onload=function(e) {
	getStatusXhr(true);
  bindings={"Zoom":{value:"0", binding:['$("#zoomslider").value'], oldvalue:"-1"}
           };
};
</script>

</head>
<body>
<div class="fs7">
  <h1>Camera WiFi Remote Control</h1>
    <table><tbody>
      <tr class="center img_sm"><td onclick="action('ZOOMOUT')"><img src="zoomout.png" alt="Zoom Out"/><br />Zoom Out</td><td onclick="action('ZOOMIN')"><img src="zoomin.png" alt="Zoom In"/><br />Zoom In</td></tr>
      <tr class="center"><td colspan="2"><progress id="zoomslider" max="100" value="50"></progress></td></tr>
      <tr class="center"><td colspan="2" onclick="shoot('SHOOT_'+$('#num_shots').value+'_'+$('#intvl').value)"><img align="middle" style="width:50%;" src="shutter.png" alt="Take Picture"/><br />Take Picture!</td></tr>
      <tr class="right"><td>Number of shots:</td><td class="left"><input id="num_shots" type="number" min="1" max="100" step="1" value="1"></td></tr>
      <tr class="right"><td>Interval between shots:</td><td class="left"><input id="intvl" type="number" min="1" max="1000" step="1" value="1"> seconds</td></tr>
      <tr class="right"><td>Delay until first shot:</td><td class="left"><input id="delay" type="number" min="0" max="1000" step="1" value="0"> seconds</td></tr>
    </tbody></table>
    <hr />
  <div id="status">
  <div id="last">
  </div>
  </div>

</div>

<div>
<p>Created by Jens Heilig, 2016-08-11</p>
<p>
Some Icons made by <a href="http://www.flaticon.com/authors/linh-pham" title="Linh Pham">Linh Pham</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a>, licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>
</p>
</div>
</body>
</html>
